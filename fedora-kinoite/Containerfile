FROM registry.fedoraproject.org/fedora:40 AS builder

RUN dnf update -y && \
    dnf install -y rust cargo && \
    cargo install bandwhich
RUN mv /root/.cargo/bin/bandwhich /

# Location not final and subject to change!
FROM quay.io/fedora-ostree-desktops/kinoite:40

LABEL org.opencontainers.image.title="Fedora Kinoite"
LABEL org.opencontainers.image.description="Customized image of Fedora Kinoite"
LABEL org.opencontainers.image.source="https://github.com/travier/fedora-kinoite"
LABEL org.opencontainers.image.licenses="MIT"
LABEL quay.expires-after=""

# Copy bandwhich from builder container
COPY --from=builder /bandwhich /usr/bin/bandwhich

RUN rpm-ostree install \
        bwm-ng \
        distrobox \
        htop \
        igt-gpu-tools \
        iotop \
        iwd \
        krb5-workstation \
        libvirt-daemon \
        libvirt-daemon-config-network \
        libvirt-daemon-driver-interface \
        libvirt-daemon-driver-network \
        libvirt-daemon-driver-nodedev \
        libvirt-daemon-driver-nwfilter \
        libvirt-daemon-driver-qemu \
        libvirt-daemon-driver-secret \
        libvirt-daemon-driver-storage-core \
        libvirt-dbus \
        netcat \
        qemu-kvm \
        sysprof \
        vim \
        wireguard-tools \
        zsh \
    && \
    systemctl enable libvirtd.socket \
        wget \
        "https://siosm.fedorapeople.org/.rpms/rpm-ostree-2024.5-3.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/rpm-ostree-libs-2024.5-3.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/plasma-discover-6.0.4-2.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/plasma-discover-flatpak-6.0.4-2.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/plasma-discover-libs-6.0.4-2.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/plasma-discover-notifier-6.0.4-2.fc40.x86_64.rpm" \
        "https://siosm.fedorapeople.org/.rpms/plasma-discover-rpm-ostree-6.0.4-2.fc40.x86_64.rpm" \
    && \
    rpm-ostree override replace ./*.rpm \
    && \
    rm -v ./*.rpm \
    && \
    rm -rf /var/lib/unbound/root.key

# Copy custom config to /usr & /etc
COPY usr usr
COPY etc etc

RUN ostree container commit
