FROM quay.io/travier/bandwhich:latest AS bandwhich

# Location not final and subject to change!
FROM quay.io/fedora-ostree-desktops/kinoite:40

LABEL org.opencontainers.image.title="Fedora Kinoite"
LABEL org.opencontainers.image.description="Customized image of Fedora Kinoite"
LABEL org.opencontainers.image.source="https://github.com/travier/fedora-kinoite"
LABEL org.opencontainers.image.licenses="MIT"
LABEL quay.expires-after=""

# Copy bandwhich from bandwhich container
COPY --from=bandwhich /usr/bin/bandwhich /usr/bin/bandwhich

# - Replace noopenh264 with openh264
# - Remove ostree-grub2, setup composefs, rebuild initramfs
# - Install bootupd and generate metadata
# - Install various packages
# - Enable libvirtd
# - Misc /var cleanup
RUN rpm-ostree override remove noopenh264 --install openh264 \
    && \
    rpm-ostree override remove ostree-grub2 && \
    echo -n "[composefs]\nenabled=yes\n" >> /usr/lib/ostree/prepare-root.conf && \
    export KERNEL_VERSION="$(rpm -qa kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}')" && \
    stock_arguments=$(lsinitrd "/lib/modules/${KERNEL_VERSION}/initramfs.img"  | grep '^Arguments: ' | sed 's/^Arguments: //') && \
    mkdir -p /tmp/dracut /var/roothome && \
    bash <(/usr/bin/echo "dracut $stock_arguments") && \
    rm -rf /var/* /tmp/*  && \
    mv -v /boot/initramfs*.img "/lib/modules/${KERNEL_VERSION}/initramfs.img" \
    && \
    rpm-ostree install bootupd && \
    /usr/bin/bootupctl backend generate-update-metadata \
    && \
    rpm-ostree install \
        bwm-ng \
        distrobox \
        htop \
        igt-gpu-tools \
        iotop \
        iwd \
        krb5-workstation \
        libvirt-daemon \
        libvirt-daemon-config-network \
        libvirt-daemon-driver-interface \
        libvirt-daemon-driver-network \
        libvirt-daemon-driver-nodedev \
        libvirt-daemon-driver-nwfilter \
        libvirt-daemon-driver-qemu \
        libvirt-daemon-driver-secret \
        libvirt-daemon-driver-storage-core \
        libvirt-dbus \
        netcat \
        qemu-kvm \
        sysprof \
        vim \
        wireguard-tools \
        zsh \
    && \
    systemctl enable libvirtd.socket \
    && \
    rm -rf /var/lib/unbound/root.key

# Copy custom config to /usr & /etc
COPY usr usr
COPY etc etc

RUN ostree container commit
